{# reports/template.md.j2 - FINAL VERSION based on uploaded report_writer.py #}
{% set audit_details = report.domain_info %}
{% set summary = report.summary_metrics %}
{% set crawled_pages = report.detailed_page_data %}
{% set audit_level = audit_details.audit_level %}
{% set audit_scope = audit_details.audit_scope %}
{% set final_score = summary.seo_score %}

# üëë SEO AUDIT REPORT for {{ audit_details.url }}

**Audit Date:** {{ audit_details.timestamp }}
**Final SEO Score:** **{{ final_score }}/100**

---

{# JINJA2 AGGREGATION BLOCKS: Calculate Site-Wide Issue Counts from detailed_page_data #}
{% set total_issue_count = 0 %}
{% set title_fail_count = 0 %}
{% set desc_fail_count = 0 %}
{% set h1_fail_count = 0 %}
{% set thin_content_count = 0 %}
{% set missing_alt_total = 0 %}
{% set broken_link_total = 0 %}

{% for page in crawled_pages %}
    {% set missing_alt_total = missing_alt_total + page.images.missing_alt %}

    {% for issue in page.issues %}
        {% set total_issue_count = total_issue_count + 1 %}
        {% if 'Title tag missing' in issue or 'Title length' in issue %}
            {% set title_fail_count = title_fail_count + 1 %}
        {% elif 'Meta description missing' in issue %}
            {% set desc_fail_count = desc_fail_count + 1 %}
        {% elif 'H1 tags' in issue %}
            {% set h1_fail_count = h1_fail_count + 1 %}
        {% elif 'Thin content' in issue %}
            {% set thin_content_count = thin_content_count + 1 %}
        {% elif 'broken external links' in issue %}
            {% set broken_link_total = broken_link_total + 1 %}
        {% endif %}
    {% endfor %}
{% endfor %}

## 1. Executive Summary and Audit Scope

This report provides a comprehensive SEO audit, with a focus on **technical health** and **on-page optimization**.

### üåê Audit Details

| Metric | Value | Details |
| :--- | :--- | :--- |
| **Audit Level** | **{{ audit_level | capitalize }}** | The {{ audit_level }} check includes {{ 'basic metadata and core health' if audit_level == 'basic' else 'full on-page analysis including content quality'}}. |
| **Crawl Scope** | **{{ audit_scope | replace('_', ' ') | capitalize }}** | {% if audit_scope == 'only_onpage' %}Only the homepage was checked.{% elif audit_scope == 'onpage_and_index_pages' %}The homepage and index pages were checked (limited to 10 pages).{% else %}A wide-scale crawl of the site up to 250 pages.{% endif %} |
| **Total Pages Crawled** | **{{ crawled_pages | length }}** | The detailed report contains findings for this many pages. |

### üö® Site-Wide Issue Overview

This table aggregates critical issues found across all **{{ crawled_pages | length }}** crawled pages.

| Issue Type | Total Count | Solution Priority |
| :--- | :--- | :--- |
| **Average SEO Score** | **{{ final_score }}/100** | Highest |
| **Pages with Title Issues** | **{{ title_fail_count }}** pages | High |
| **Pages Missing Meta Descriptions** | **{{ desc_fail_count }}** pages | High |
| **Pages with H1 Issues (0 or >1)** | **{{ h1_fail_count }}** pages | High |
{% if broken_link_total > 0 %}
| **Pages with Broken Links** | **{{ broken_link_total }}** pages | Medium |
{% endif %}
| **Total Images Missing ALT Text** | **{{ missing_alt_total }}** images | Low |

---

## 2. Core Technical Health & Performance

| Check | Status | Details |
| :--- | :--- | :--- |
| **SSL/HTTPS** | **{{ '‚úÖ Valid HTTPS' if audit_details.ssl.valid_ssl else '‚ùå Missing or Invalid' }}** | {{ audit_details.ssl.message or "Verified by the check." }} |
| **Robots/Sitemap** | **{{ '‚úÖ Found' if 'found' in audit_details['robots_sitemap']['robots.txt'] else '‚ùå Not Found' }}** | Robots status: {{ audit_details['robots_sitemap']['robots.txt'] }}; Sitemap status: {{ audit_details['robots_sitemap']['sitemap.xml'] }}. |
| **Initial Load Time** | **{{ audit_details.performance.load_time_ms }}ms** | Measured from a single request (Target: < 500ms). |

{% if audit_details.competitor_data.status == "success" %}
### üìà Basic Competitor Comparison
| Metric | Your Site (Homepage) | Competitor Site ({{ audit_details.competitor_data.url }}) |
| :--- | :--- | :--- |
| **Title Length** | {{ crawled_pages[0].meta.title|length }} | {{ audit_details.competitor_data.title_length }} |
| **H1 Count** | {{ crawled_pages[0].headings.h1 }} | {{ audit_details.competitor_data.h1_count }} |
| **Word Count** | {{ crawled_pages[0].content.word_count }} | {{ audit_details.competitor_data.word_count }} |
{% endif %}

---

## 3. Detailed On-Page Audit Checklist

{% for page in crawled_pages %}
### Page {{ loop.index }}: `{{ page.url }}` (Score: {{ page.final_score or page.seo_score }}/100, Status: {{ page.status_code }})

| Core Metric | Value | Issue/Status |
| :--- | :--- | :--- |
| **Title Tag** | {{ page.meta.title or "‚ùå MISSING" }} | **Length:** {{ page.meta.title|length if page.meta.title else 'N/A' }} |
| **Meta Description** | {{ page.meta.description or "‚ùå MISSING" }} | **Length:** {{ page.meta.description|length if page.meta.description else 'N/A' }} |
| **H1 Count** | {{ page.headings.h1 }} | Must be exactly 1. |
| **Word Count** | {{ page.content.word_count }} | |
| **Mobile Friendly** | {{ '‚úÖ' if page.mobile.mobile_friendly else '‚ùå' }} | |

#### üöß Actionable Issues Found & Solutions

{% if page.issues %}
    {% for issue, solution in zip(page.issues, page.solutions) %}
- **{{ issue }}**
  - *Solution:* {{ solution }}
    {% endfor %}
{% else %}
‚úÖ No major issues found on this page that require immediate action.
{% endif %}

---
{% endfor %}

## 4. Final Disclaimer

This audit covers **technical** and **on-page** SEO using a proprietary, limited-depth crawler. This tool is designed to provide actionable solutions based on industry best practices.

**Data NOT Included in This Report:**
* Backlinks (Inbound Links) and external domain authority.
* Keyword Rankings, Organic Traffic, or Search Console data.
* Guaranteed speed metrics (relies on a basic single-request load time).

**Report Generated By:** Automated Zero-Cost SEO Audit Tool
**Audit ID:** `{{ audit_details.timestamp }}`
